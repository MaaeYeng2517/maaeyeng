<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Webboard Pro Ultimate</title>
<style>
body,html{margin:0;padding:0;height:100%;font-family:sans-serif;display:flex;overflow:hidden;}
#sidebar{width:320px;background:#0b1220;color:#e6eef8;display:flex;flex-direction:column;padding:8px;gap:6px;}
.input{padding:6px;border-radius:4px;border:none;width:100%;box-sizing:border-box;}
.btn{padding:6px;border-radius:4px;border:none;background:#06b6d4;color:#001;cursor:pointer;}
#canvasWrap{flex:1;position:relative;}
canvas{background:#fff;display:block;width:100%;height:100%;}
#chatBox{flex:1;background:rgba(255,255,255,0.05);overflow:auto;padding:4px;border-radius:4px;}
.msg{padding:2px 4px;margin-bottom:2px;background:rgba(255,255,255,0.1);border-radius:4px;}
.user-cursor{position:absolute;width:12px;height:12px;background:red;border-radius:50%;pointer-events:none;font-size:10px;color:#fff;text-align:center;line-height:12px;}
.toolbar, .suboptions{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:4px;}
</style>
</head>
<body>
<div id="sidebar">
  <input id="username" class="input" placeholder="ชื่อผู้ใช้">
  <button id="loginBtn" class="btn">Login</button>

  <h4>Boards</h4>
  <select id="boardSelect" class="input"></select>
  <button id="newBoard" class="btn">New Board</button>

  <h4>Tools</h4>
  <div class="toolbar">
    <button class="btn tool" data-tool="brush">Brush</button>
    <button class="btn tool" data-tool="line">Line</button>
    <button class="btn tool" data-tool="rect">Rect</button>
    <button class="btn tool" data-tool="circle">Circle</button>
    <button class="btn tool" data-tool="triangle">Triangle</button>
    <button class="btn tool" data-tool="arrow">Arrow</button>
  </div>
  <div class="suboptions">
    Color: <input type="color" id="color" value="#06b6d4">
    Size: <input type="number" id="size" value="4" min="1" max="50">
    <button id="undo" class="btn">Undo</button>
    <button id="redo" class="btn">Redo</button>
    <button id="exportPNG" class="btn">Export PNG</button>
    <button id="exportSVG" class="btn">Export SVG</button>
  </div>

  <h4>Chat</h4>
  <div id="chatBox"></div>
  <div style="display:flex;gap:4px;">
    <input id="chatInput" class="input">
    <button id="sendChat" class="btn">Send</button>
  </div>
</div>

<div id="canvasWrap">
  <canvas id="canvas"></canvas>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let dpr = window.devicePixelRatio || 1;
function resizeCanvas(){
  canvas.width = canvas.clientWidth*dpr;
  canvas.height = canvas.clientHeight*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// App State
let username='', currentBoard='', tool='brush', color='#06b6d4', size=4;
let drawing=false, startPoint=null;
let ws;
const undoStack = [], redoStack = [];
const layers = []; // simple per-user layers for demo
const chatBox = document.getElementById('chatBox');
const cursors = {}; // userId -> DOM element

function connectWS(){
  ws = new WebSocket('ws://localhost:8080');
  ws.onopen = ()=> console.log('Connected');
  ws.onmessage = e=>{
    const msg = JSON.parse(e.data);
    switch(msg.type){
      case 'loginSuccess':
        username = msg.user.username;
        break;
      case 'init':
        populateBoards(msg.state.boards);
        break;
      case 'boardCreated':
        addBoardOption(msg.boardId,msg.name);
        break;
      case 'draw':
        drawStroke(msg.stroke);
        break;
      case 'chat':
        addChat(msg.message);
        break;
      case 'cursor':
        showCursor(msg.id,msg.cursor,msg.name);
        break;
      case 'userLeft':
        removeCursor(msg.id);
        break;
    }
  };
}

// Login
document.getElementById('loginBtn').addEventListener('click',()=>{
  const user = document.getElementById('username').value.trim();
  if(!user) return;
  ws.send(JSON.stringify({type:'login', username: user}));
});

// Board
function populateBoards(boards){
  const sel = document.getElementById('boardSelect');
  sel.innerHTML='';
  for(const id in boards) addBoardOption(id,boards[id].name);
}
function addBoardOption(id,name){
  const sel = document.getElementById('boardSelect');
  const opt = document.createElement('option'); opt.value=id; opt.textContent=name;
  sel.appendChild(opt);
}
document.getElementById('newBoard').addEventListener('click',()=>{
  const name = prompt('Board Name');
  if(!name) return;
  ws.send(JSON.stringify({type:'createBoard', name}));
});

// Tool selection
document.querySelectorAll('.tool').forEach(btn=>{
  btn.addEventListener('click',()=>tool=btn.dataset.tool);
});
document.getElementById('color').addEventListener('change', e=>color=e.target.value);
document.getElementById('size').addEventListener('change', e=>size=parseInt(e.target.value));

// Canvas Drawing
canvas.addEventListener('pointerdown', e=>{
  drawing=true;
  startPoint={x:e.offsetX, y:e.offsetY};
});
canvas.addEventListener('pointermove', e=>{
  if(!drawing) return;
  const end={x:e.offsetX, y:e.offsetY};
  const stroke={boardId:currentBoard||'b_demo', layerId:'l_demo', tool, start:startPoint, end, color, size};
  drawStroke(stroke);
  if(ws) ws.send(JSON.stringify({type:'draw', stroke}));
  startPoint=end;
  if(ws) ws.send(JSON.stringify({type:'cursor', cursor:{x:e.clientX,y:e.clientY}, name: username}));
});
canvas.addEventListener('pointerup', e=>drawing=false);

function drawStroke(s){
  ctx.strokeStyle=s.color;
  ctx.lineWidth=s.size;
  ctx.beginPath();
  ctx.moveTo(s.start.x, s.start.y);
  ctx.lineTo(s.end.x, s.end.y);
  ctx.stroke();
}

// Chat
document.getElementById('sendChat').addEventListener('click',()=>{
  const msg=document.getElementById('chatInput').value.trim();
  if(!msg) return;
  ws.send(JSON.stringify({type:'chat', boardId:currentBoard||'b_demo', message:msg}));
  document.getElementById('chatInput').value='';
});
function addChat(msg){
  const div=document.createElement('div'); div.className='msg'; div.textContent=`${msg.user}: ${msg.message}`;
  chatBox.appendChild(div); chatBox.scrollTop = chatBox.scrollHeight;
}

// Cursor
function showCursor(id,pos,name){
  let el = cursors[id];
  if(!el){
    el=document.createElement('div'); el.className='user-cursor'; el.textContent=name[0]; document.getElementById('canvasWrap').appendChild(el);
    cursors[id]=el;
  }
  el.style.left=(pos.x-6)+'px'; el.style.top=(pos.y-6)+'px';
}
function removeCursor(id){ const el=cursors[id]; if(el) el.remove(); delete cursors[id]; }

// Undo/Redo
document.getElementById('undo').addEventListener('click',()=>{ctx.clearRect(0,0,canvas.width,canvas.height);});
document.getElementById('redo').addEventListener('click',()=>{ctx.clearRect(0,0,canvas.width,canvas.height);});

// Export
document.getElementById('exportPNG').addEventListener('click',()=>{
  const data = canvas.toDataURL('image/png');
  const a=document.createElement('a'); a.href=data; a.download='drawing.png'; a.click();
});
document.getElementById('exportSVG').addEventListener('click',()=>{
  alert('Export SVG ยังไม่ได้ implement ในตัวอย่างนี้');
});

connectWS();
</script>
</body>
</html>